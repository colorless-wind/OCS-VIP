<style lang="less" scoped>
    @import "../../assets/less/config";

    #chargePayPage.content {
        background-color: white;
    }

    #chargePayPage .charge-index {
        margin: 0;
    }

    #chargePayPage .charge-index .banner {}

    #chargePayPage .charge-index .banner img {
        width: 100%;
    }

    #chargePayPage .charge-index .title {
        padding: 5px 15px;
        font-size: 16px;
        margin-top: 20px;
    }

    #chargePayPage .charge-index hr {
        margin-bottom: 10%;
        border: none;
        border-bottom: 1px solid #D9D9D9;
    }

    #chargePayPage .charge-index .charge-btn {
        text-align: center;
        position: fixed;
        bottom: 0;
        width: 100%;
    }

    #chargePayPage .charge-index .charge-btn button {
        width: 100%;
        line-height: 50px;
        border: none;
        font-size: 14px;
        color: #fff;
        background: #62a8ea;
    }

    #chargePayPage .charge-index .charge-input {
        padding: 20px 15px;
        font-size: 22px;
    }

    #chargePayPage .charge-index .charge-input input {
        border: none;
        font-size: 20px;
    }

    #chargePayPage .charge-index .charge-input input::-webkit-input-placeholder {
        /* WebKit, Blink, Edge */
        color: #ccc;
    }

    #chargePayPage .charge-index .charge-input input:-moz-placeholder {
        /* Mozilla Firefox 4 to 18 */
        color: #ccc;
    }

    #chargePayPage .charge-index .charge-input input::-moz-placeholder {
        /* Mozilla Firefox 19+ */
        color: #ccc;
    }

    #chargePayPage .charge-index .charge-input input:-ms-input-placeholder {
        /* Internet Explorer 10-11 */
        color: #ccc;
    }

    #chargePayPage .charge-index .marquee-content {
        /*        text-align: center;*/
        padding-left: 15px;
    }

    #chargePayPage .charge-index .marquee-content img {
        width: 18px;
        vertical-align: text-bottom;
        margin-right: 5px;
    }

    #chargePayPage .discount {
        border-width: 0px;
        width: 39px;
        background: inherit;
        background-color: #ff5918;
        border: none;
        border-radius: 13px;
        box-shadow: none;
        font-weight: 400;
        font-style: normal;
        color: #FFFFFF;
        display: inline-block;
        text-align: center;
        line-height: 22px;
        font-size: 12px;
        margin-left: 10px;
    }


    #chargePayPage .charge-detail {
        padding-top: 10%;
    }

    #chargePayPage .charge-detail .form {
        margin: 10px;
    }

    #chargePayPage .charge-detail .form .title {
        padding: 5px;
        font-size: 18px;
        text-align: center;
    }

    #chargePayPage .charge-detail .form .money {
        color: #ff6600;
        padding: 5px;
        font-size: 28px;
        text-align: center;
    }

    #chargePayPage .charge-detail .form .status {
        color: #999;
        padding: 5px;
        font-size: 14px;
        text-align: center;
        margin-bottom: 10%;
    }

    #chargePayPage .charge-detail .form .item {
        padding: 2px 15px;
    }

    #chargePayPage .charge-detail .form hr {
        margin: 10px 20px;
    }

    #chargePayPage .charge-detail .form .item .description-label {
        padding: 5px;
        width: 45%;
        font-size: 14px;
        color: #999;
        display: inline-block;
    }

    #chargePayPage .charge-detail .form .item .description-value {
        padding: 5px;
        width: 45%;
        font-size: 14px;
        display: inline-block;
        text-align: right;
    }

    #chargePayPage .charge-detail .form .item .type-label {
        padding: 5px;
        width: 45%;
        font-size: 14px;
        color: #999;
        display: inline-block;
    }

    #chargePayPage .charge-detail .form .item .type-value {
        padding: 5px;
        width: 45%;
        font-size: 14px;
        display: inline-block;
        text-align: right;
    }

    #chargePayPage .charge-detail .form .item .saler-name-label {
        padding: 5px;
        width: 45%;
        font-size: 14px;
        color: #999;
        display: inline-block;
    }

    #chargePayPage .charge-detail .form .item .saler-name-value {
        padding: 5px;
        width: 45%;
        font-size: 14px;
        display: inline-block;
        text-align: right;
    }

    #chargePayPage .charge-detail .form .item .order-number-label {
        padding: 5px;
        width: 22%;
        font-size: 14px;
        color: #999;
        display: inline-block;
    }

    #chargePayPage .charge-detail .form .item .order-number-value {
        padding: 5px;
        width: 68%;
        font-size: 14px;
        display: inline-block;
        text-align: right;
    }

    #chargePayPage .charge-detail .form .item .order-time-label {
        padding: 5px;
        width: 22%;
        font-size: 14px;
        color: #999;
        display: inline-block;
    }

    #chargePayPage .charge-detail .form .item .order-time-value {
        padding: 5px;
        width: 68%;
        font-size: 14px;
        display: inline-block;
        text-align: right;
    }

    #chargePayPage .charge-detail .charge-btn {
        text-align: center;
        position: fixed;
        bottom: 0;
        width: 100%;
    }

    #chargePayPage .charge-detail .charge-btn button {
        width: 100%;
        line-height: 45px;
        border: none;
        font-size: 14px;
        color: #fff;
        background: #62a8ea;
    }

    #chargePayPage .charge-detail .item-box {
        border: 1px solid #ccc;
    }

    #chargePayPage .charge-detail .real-money {
        color: #FFC107;
        font-weight: bold;
        font-size: 14px;
    }

</style>
<style>
    /*#chargePayPage .charge-index .vux-radio-icon {
        width: 30px;
        height: auto;
    }

    #chargePayPage .weui-cells {
        margin-top: 5px;
    }

    #chargePayPage .charge-index .weui-cells_radio .weui-check:checked+.weui-icon-checked:before {
        color: #118ee9;
    }*/

</style>
<template>
<div>
    <v-header title=""></v-header>
    <v-content id="chargePayPage">
        <div class="charge-detail">
            <div class="form">
                <p class="title">会员卡充值</p>
                <p class="money">{{info.money / 100}} ￥</p>
                <div class="item-box">
                <div class="item">
                    <p class="description-label">活动信息</p>
                    <p class="description-value">{{info.activity}}</p>
                </div>
                <div class="item">
                    <p class="type-label">折扣信息</p>
                    <p class="type-value">{{info.discount}}</p>
                </div>
                <div class="item">
                    <p class="type-label">折扣金额</p>
                    <p class="type-value">{{info.discountMoney / 100}} ￥</p>
                </div>
                <div class="item">
                    <p class="saler-name-label">支付方式</p>
                    <p class="saler-name-value">{{info.payway}}</p>
                </div>
                </div>
            </div>
            <!--* 充值按钮 *-->
            <div class="charge-btn">
                <button type="button" @click="addOrder" :disabled="lockChargeBtn">微信支付 <span class="real-money">{{info.realMoney?(info.realMoney / 100)+' 元':''}}</span></button>
            </div>
            
            <div class="payPics" v-show="false">
                <img src="../../assets/images/charge/wechat_pay.png" />
                <img src="../../assets/images/charge/zhifubao_pay.png" />
                <img src="../../assets/images/charge/bank_pay.png" />
            </div>
        </div>
        <!--* 加载动画 load true/false 显示/隐藏；type 1-7 7种样式 *-->
        <v-loading :type="1" :load="loading" :msg="loadingMsg"></v-loading>
    </v-content>
</div>
</template>
<script>
    //* 引用工具函数包并以混入的形式加载
    import util from '../../assets/js/util'
    //* 引用jQuery库
    import $ from 'jquery'
    //* 引用vux组件
    import {
        Group,
        Cell,
        Radio,
        Marquee,
        MarqueeItem
    } from 'vux'

    export default {
        components: {
            Group,
            Cell,
            Radio,
            Marquee,
            MarqueeItem
        },
        data() {
            return {
                //* 详情信息
                info: {
                    money: '',
                    discountMoney: '',
                    status: '',
                    way: '',
                    type: '',
                    salerName: '',
                    orderNo: '',
                    orderTime: '',
                    activity: '',
                    discount: '',
                    payway: '微信支付',
                },
                //* 设置默认选中的支付方式
                selectedPayWay: 'wxpay',
                //* 支付方式配置
                payOptions: [{
                        icon: 'http://dn-placeholder.qbox.me/110x110/FF2D55/000',
                        key: 'wxpay',
                        value: '微信支付'
                    }
                    /*, {
                                        icon: 'http://dn-placeholder.qbox.me/110x110/FF2D55/000',
                                        key: 'alipay',
                                        value: '支付宝支付',
                                    }, {
                                        icon: 'http://dn-placeholder.qbox.me/110x110/FF2D55/000',
                                        key: 'bankpay',
                                        value: '银联支付',
                                    }*/
                ],
                //* 是否启用加载动画
                enableLoading: true,
                //* 加载动画显示状态
                loading: false,
                //* 加载动画提示文字
                loadingMsg: '',
                //* 充值金额
                chargeMoney: '',
                activityInfo: {
                    favmoney: 0,
                    goodId: '',
                    goodName: '',
                    num: 1,
                    price: 0,
                    promotion: null,
                    promotionType: 0,
                    realPrice: 0
                },
                //* 微信支付参数
                wxPayParam: {
                    //* 时间戳 微信API参数
                    "timeStamp": '',
                    //* 签名类型 微信API参数
                    "signType": "MD5",
                    //* 包名 微信API参数
                    "package": '',
                    //* 公众号id 微信API参数
                    "appId": '',
                    //* 生成签名的随机串 微信API参数
                    "nonceStr": '',
                    //* 签名 微信API参数
                    "paySign": ''
                }
            }
        },
        mounted() {
            window.$ = $;
            //* 未连接MQTT时，开始连接MQTT
            console.log(this.$mqttClient.isConnected())
            if (!this.$mqttClient.isConnected()) {
                //* 注册mqtt实例并创建连接
                this.MqttConnectReady();
            }
            //* 设定支付方式图标
            this.payOptions[0].icon = $('.payPics').find('img')[0].src;
            /*this.payOptions[1].icon = $('.payPics').find('img')[1].src;
            this.payOptions[2].icon = $('.payPics').find('img')[2].src;*/
            console.log(sessionStorage.getItem('cm'))
            this.chargeMoney = parseInt(sessionStorage.getItem('cm'));
            //this.info.activity = this.$wsCache.get('currentActivity').commonActivityName || '暂无活动';
            this.info.activity = '暂无活动';
            //let ruleContents = JSON.parse(this.$wsCache.get('currentActivity').commonActivityRule).contents;
            this.info.discount = '无';
            this.info.money = this.chargeMoney * 100;
            this.info.realMoney = this.chargeMoney * 100;


            //sessionStorage.removeItem('cm')
            this.getActivity();

            this.stopDrop()
        },
        methods: {
            /**
             * 禁止浏览器下拉回弹
             */
            stopDrop() {
                var lastY; //最后一次y坐标点
                $(".content").on('touchstart', function(event) {
                    lastY = event.originalEvent.changedTouches[0].clientY; //点击屏幕时记录最后一次Y度坐标。
                });
                $(".content").on('touchmove', function(event) {
                    var y = event.originalEvent.changedTouches[0].clientY;
                    var st = $(this).scrollTop(); //滚动条高度
                    console.log("st = " + st);
                    if (y >= lastY && st <= 0) { //如果滚动条高度小于0，可以理解为到顶了，且是下拉情况下，阻止touchmove事件。
                        lastY = y;
                        event.preventDefault();
                    }
                    lastY = y;

                    //方法三
                    // var abc=$(document.body).scrollTop();
                    // console.log("abc = "+abc);
                    // if (abc>0) {
                    //   $(document.body).scrollTop(0);
                    // }
                });
            },
            /**
             * 功能 适配手机软键盘弹出影响布局的问题
             * 参数 无
             * 返回 无
             **/
            fitKeyBoardFocus() {
                let me = this
                let oriWinHeight = window.innerHeight
                window.onresize = function() {
                    //me.isKeybordAvail = true
                    let newHeight = window.innerHeight
                    // 阀值大于140判断为键盘收起
                    if (newHeight - oriWinHeight > 140) {
                        // me.oprNum('input')
                        $('.charge-btn').css('position', 'fixed');
                    } else {
                        $(".content").animate({
                            scrollTop: 100
                        });
                        //$(".content").scrollTop(100);
                        $('.charge-btn').css('position', 'relative');
                    }
                    oriWinHeight = newHeight
                }
            },
            /**
             * 功能 调用微信支付
             * 参数 无
             * 返回 无
             **/
            wxPay: function() {
                // var data = {
                // "timeStamp":"1495111085",
                // "signType":"MD5",
                // "package":"prepay_id=wx20170518203805c6fb7213b20085122577",
                // "appId":"wxb682f27fc36ca21b",
                // "nonceStr":"XJelL2ZWroJPuRyF3CjGJxzCuKRfmz0e",
                // "paySign":"EF9FA8423258108574882E83EBA67BBA"};
                var data = {
                    "timeStamp": this.wxPayParam.timeStamp,
                    "signType": this.wxPayParam.signType,
                    "package": this.wxPayParam.package,
                    "appId": this.wxPayParam.appId,
                    "nonceStr": this.wxPayParam.nonceStr,
                    "paySign": this.wxPayParam.paySign
                };

                alert(JSON.stringify(data))
                if (!data) return false;
                //* 发起支付请求
                WeixinJSBridge.invoke(
                    'getBrandWCPayRequest',
                    data,
                    function(res) {
                        //* 状态信息
                        //* get_brand_wcpay_request:ok 支付成功
                        //* get_brand_wcpay_request:fail 支付失败
                        //* get_brand_wcpay_request:cancel 支付过程中用户取消
                        //* get_brand_wcpay_request:ok 仅在用户成功完成支付时返回。由于前端交互复杂，get_brand_wcpay_request:cancel 或者 get_brand_wcpay_request:fail 可以统一处理为用户遇到错误或者主动放弃，不必细化区分
                        if (res.err_msg == "get_brand_wcpay_request:ok") {
                            //location.href = location.href.replace(location.search, '').replace('?#', '#').replace('payconfirm', 'paysuccess');
                        } else {
                            alert(res.err_msg);
                            //alert(JSON.stringify(res));
                        }
                    });
            },
            /**
             * 功能 调用微信支付前，检测支付环境（微信API是否生效）
             * 参数 无
             * 返回 无
             **/
            checkPayEnv: function() {
                if (typeof WeixinJSBridge == "undefined") {
                    if (document.addEventListener) {
                        document.addEventListener('WeixinJSBridgeReady', this.wxPay, false);
                    } else if (document.attachEvent) {
                        document.attachEvent('WeixinJSBridgeReady', this.wxPay);
                        document.attachEvent('onWeixinJSBridgeReady', this.wxPay);
                    }
                } else {
                    //* 调用微信支付
                    this.wxPay();
                }
            },
            /**
             * 功能 调用微信支付前，检测支付环境（微信API是否生效）
             * 参数 无
             * 返回 无
             **/
            addOrder() {
                var testparam = {
                    "channel": "OCS",
                    "scene": "MemberService",
                    "userName": "15611740510",
                    "userId": "9d3278dc97894f7098de8288b8776e68",
                    "permissionId": "ef0ed71b070c41ed93decdc2424c5d09",
                    "merchantId": "8374f2833044427a8d96afa5779c904c",
                    "merchantName": "测试账户002",

                    "favMoney": 0,
                    "favfare": 0,
                    "fare": 0,
                    "payMoney": 300,
                    "money": 300,
                    "orderNo": "1234567890",
                    "goods": [{
                        "goodId": "12345",
                        "goodName": "ewfqr",
                        "num": 1,
                        "price": 30,
                        "realPrice": 300,
                        "favmoney": 300,
                        "promotiontype": 1,
                        "promotion": 0
                    }]
                }
                //* 设定加载提示信息
                this.loadingMsg = this.CONST.MSG.commonLoading;
                //* 发送请求
                this.post(this.CONST.BASE_URL, this.getSendData({
                    userId: this.$wsCache.get('id') || 'not login',
                    permissionId: this.$wsCache.get('token') || 'not login',
                    userName: this.$wsCache.get('username') || 'not login',
                    merchantId: sessionStorage.getItem('merchantId') || 'no merchantId',
                    merchantName: sessionStorage.getItem('merchantName') || 'no merchantName',
                    favMoney: this.info.discountMoney,
                    favfare: 0,
                    fare: 0,
                    payMoney: this.info.realMoney || 'no final money', //最终使用的数值
                    money: this.info.money,
                    orderNo: '1234567890',
                    goods: [{
                        goodId: this.activityInfo.goodId,
                        goodName: this.activityInfo.goodName,
                        num: this.activityInfo.num,
                        price: this.activityInfo.price,
                        realPrice: this.activityInfo.realPrice,
                        favmoney: this.activityInfo.favmoney,
                        promotiontype: this.activityInfo.promotionType,
                        promotion: this.activityInfo.promotion
                    }]
                }, this.CONST.APP_ID, this.CONST.METHOD.addOrder, this.CONST.PWD), this).then((response) => {
                    console.log('访问成功');
                    console.log(response);
                    if (0 == response.subStatus && 0 == response.status) {
                        //* 获取支付方式
                        console.log(this.selectedPayWay);
                        //* 设定支付参数
                        this.wxPayParam.timeStamp = response.data.timestamp;
                        this.wxPayParam.package = response.data.packageStr;
                        this.wxPayParam.appId = response.data.appId;
                        this.wxPayParam.nonceStr = response.data.nonceStr;
                        this.wxPayParam.paySign = response.data.sign;
                        //* 检测支付环境
                        //this.checkPayEnv();
                        sessionStorage.setItem('chargeMoney', this.info.money / 100);
                    } else {
                        this.lockChargeBtn = false;
                        if (0 != response.status) {
                            this.toast(response.errorMsg);
                            return false;
                        }
                        if (0 != response.subStatus) {
                            this.toast(this.CONST.TRANSCODE[response.subStatus]);
                            this.cleanToken(response.subStatus);
                            return false;
                        }
                    }
                }).catch((err) => {
                    this.lockChargeBtn = false;
                    console.warn(err);
                })
            },
            /**
             * 功能 获取活动信息
             * 参数 无
             * 返回 无
             **/
            getActivity() {
                //* 消费活动则不调用充值结算接口
                let activity = this.$wsCache.get('currentActivity') || '';
                if (activity.commonActivityType === 1) {
                    return false;
                }
                this.lockChargeBtn = true;
                //* 设定加载提示信息
                this.loadingMsg = this.CONST.MSG.commonLoading;
                let testparam = {
                    " money ": 600,
                    " activityId ": "111",
                    "merchantId": "8374f2833044427a8d96afa5779c904c",
                    "merchantName": "测试账户002",
                }

                //* 发送请求
                this.post(this.CONST.BASE_URL, this.getSendData({
                    userId: this.$wsCache.get('id') || 'not login',
                    permissionId: this.$wsCache.get('token') || 'not login',
                    userName: this.$wsCache.get('username') || 'not login',
                    merchantId: sessionStorage.getItem('merchantId') || 'no merchantId',
                    merchantName: sessionStorage.getItem('merchantName') || 'no merchantName',
                    activityId: this.$wsCache.get('currentActivity') ? this.$wsCache.get('currentActivity').commonActivityId : '' || 'no activityId',
                    money: this.chargeMoney * 100,
                }, this.CONST.APP_ID, this.CONST.METHOD.getActivityRechargeMoney, this.CONST.PWD), this).then((response) => {
                    console.log('访问成功');
                    console.log(response);
                    if (0 == response.subStatus && 0 == response.status) {
                        this.info.realMoney = response.data.payMoney;
                        this.info.money = response.data.tradeMoney;
                        if (this.info.money !== this.info.realMoney) {
                            this.info.activity = this.$wsCache.get('currentActivity') ? this.$wsCache.get('currentActivity').commonActivityName : '暂无活动';
                        }
                        let rule = this.$wsCache.get('currentActivity') ? JSON.parse(this.$wsCache.get('currentActivity').commonActivityRule) : '';
                        let ruleContents = this.$wsCache.get('currentActivity') ? JSON.parse(this.$wsCache.get('currentActivity').commonActivityRule).contents : [];
                        for (let i in ruleContents) {
                            if (this.chargeMoney * 100 >= ruleContents[i].baseMoney) {
                                this.info.discount = '充值满' + ruleContents[i].baseMoney / 100 + '元' + (rule.type === 0 ? '减' : '送') + ruleContents[i].actMoney / 100 + '元';
                                this.info.discountMoney = ruleContents[i].actMoney;
                            }
                        }
                        this.lockChargeBtn = false;
                    } else {
                        this.lockChargeBtn = false;
                        if (0 != response.status) {
                            this.toast(response.errorMsg);
                            return false;
                        }
                        if (0 != response.subStatus) {
                            if (response.subStatus == '030000000004') {
                                return false;
                            }
                            this.toast(this.CONST.TRANSCODE[response.subStatus]);
                            this.cleanToken(response.subStatus);
                            return false;
                        }
                    }
                }).catch((err) => {
                    this.lockChargeBtn = false;
                    console.warn(err);
                })
            },
            /**
             * 功能 获取活动信息
             * 参数 无
             * 返回 无
             **/
            getActivityOld() {
                this.lockChargeBtn = true;
                //* 设定加载提示信息
                this.loadingMsg = this.CONST.MSG.commonLoading;
                //* 发送请求
                this.post(this.CONST.BASE_URL, this.getSendData({
                    userId: this.$wsCache.get('id') || 'not login',
                    permissionId: this.$wsCache.get('token') || 'not login',
                    userName: this.$wsCache.get('username') || 'not login',
                    merchantId: sessionStorage.getItem('merchantId') || 'no merchantId',
                    merchantName: sessionStorage.getItem('merchantName') || 'no merchantName',
                    goods: [{
                        goodId: '1', // 模拟数据
                        goodName: 'this is a test good', // 模拟数据
                        num: 1, // 模拟数据
                        price: this.chargeMoney * 100 //真实数据
                    }]
                }, this.CONST.APP_ID, this.CONST.METHOD.getActivity, this.CONST.PWD), this).then((response) => {
                    console.log('访问成功');
                    console.log(response);
                    if (0 == response.subStatus && 0 == response.status) {
                        let finalMoney = response.data.goods[0].realPrice * response.data.goods[0].num - response.data.goods[0].favmoney;
                        console.log(finalMoney)
                        this.activityInfo.favmoney = response.data.goods[0].favmoney;
                        this.activityInfo.goodId = response.data.goods[0].goodId;
                        this.activityInfo.goodName = response.data.goods[0].goodName;
                        this.activityInfo.num = response.data.goods[0].num;
                        this.activityInfo.price = response.data.goods[0].price;
                        this.activityInfo.promotion = response.data.goods[0].promotion;
                        this.activityInfo.promotionType = response.data.goods[0].promotionType;
                        this.activityInfo.realPrice = finalMoney;
                        this.lockChargeBtn = false;
                    } else {
                        this.lockChargeBtn = false;
                        if (0 != response.status) {
                            this.toast(response.errorMsg);
                            return false;
                        }
                        if (0 != response.subStatus) {
                            this.toast(this.CONST.TRANSCODE[response.subStatus]);
                            this.cleanToken(response.subStatus);
                            return false;
                        }
                    }
                }).catch((err) => {
                    this.lockChargeBtn = false;
                    console.warn(err);
                })
            },
        },
        mixins: [util]
    }

</script>
